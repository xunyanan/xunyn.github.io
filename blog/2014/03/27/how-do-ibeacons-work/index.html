
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>How do iBeacons work - 寻亚楠的博客</title>
	<meta name="author" content="寻亚楠">

	
	<meta name="description" content="原文地址 iBeacons iBeacons最近是一个趋势的话题，它们允许室内定位，让你的电话知道你在基站的范围。这个能有许多应用：在停车场帮你找到你的车，零售商通过优惠券和基于位置的特别优惠，以至许多现在不敢想象的应用。 关于iBeacons和如何使用它有许多博文，但从技术角度，他们如何工作， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="寻亚楠的博客" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript">
    
    function addBlankTargetForLinks () {
        
        $('a[href^="http"]').each(function(){
                                  
                                  $(this).attr('target', '_blank');
                                  
                                  });
        
    }
    
    $(document).bind('DOMNodeInserted', function(event) {
                     
                     addBlankTargetForLinks();
                     
                     });
    
</script>
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">寻亚楠的博客</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">首页</a></li>
	<li><a href="/blog/archives">所有文章</a></li>
    <li><a href="/category">分类阅读</a></li>

    <li><a href="/about">关于我</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">首页</a></li>
	<li><a href="/blog/archives">所有文章</a></li>
    <li><a href="/category">分类阅读</a></li>

    <li><a href="/about">关于我</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:xunyanan.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:xunyanan.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">How Do iBeacons Work</h2>
	<div class="entry-content"><p><a href="http://www.warski.org/blog/2014/01/how-ibeacons-work/">原文地址</a></p>

<h2>iBeacons</h2>

<p>iBeacons最近是一个趋势的话题，它们允许室内定位，让你的电话知道你在基站的范围。这个能有许多应用：在停车场帮你找到你的车，零售商通过优惠券和基于位置的特别优惠，以至许多现在不敢想象的应用。<br/>
<img src="http://xunyanan.com/images/blog/iStock_000019319211Large-300x187.jpg" alt="iBeacons" />
关于iBeacons和如何使用它有许多博文，但从技术角度，他们如何工作，深层的技术是低功耗蓝牙，等等。。。</p>

<h2>什么是低功耗蓝牙</h2>

<p><a href="http://en.wikipedia.org/wiki/Bluetooth_low_energy">低功耗蓝牙</a>是发布在2010年的蓝牙4.0规范的一部分，它在Nokia发起于2006年，但合并到蓝牙技术，它是同经典蓝牙不同的一组协议，并且设备不向后兼容。因此有会遇到三种设备
<em>蓝牙：仅支持经典模式
</em>智能蓝牙过渡(Bluetooth Smart Ready):支持经典模式和LE(Low Energy)模式
*智能蓝牙：仅支持LE模式<br/>
<img src="http://xunyanan.com/images/blog/LogoBluetoothSmartReady-300x130.jpg" alt="Bluetooth Smart Ready" />
</br><br/>
新的智能手机（iPhone 4S+,SG3+）,笔记本，平板电脑，装备了蓝牙4.0，因为已经是智能蓝牙过渡，Beacons，从另一方面讲，仅支持低功耗协议(允许他们在一块电池的情景下，工作足够长的时间)，因此他们实现了智能蓝牙，旧的设备，如外设、车载系统、旧手机通常仅支持经典蓝牙协议。<br/>
低功耗蓝牙主要关注点，理所当然在低功耗上。例如一些Beacons在一块纽扣电池下（电池通常不更换，除非当beacon停止工作时，才需要更换）可以持续两年传输信号。低功耗蓝牙同经典蓝牙都使用相同的频谱范围（2.4GHZ&mdash;2.4835GHZ）。低功耗蓝牙有更低的传输速率，尽管它的本意不是流传输大量数据，而是发现和简单通讯。在理论范围，低功耗蓝牙和经典蓝牙信号都可以最远达到100米。</p>

<h2>低功耗蓝牙如何通讯</h2>

<p>低功耗蓝牙有两种主状态:广播和连接。  <br/>
广播是单向的被发现机制，想要被发现的设备可以传输数据包每20ms到10秒。越短的时间间隔，越短的电池寿命，但设备发现速度越快。数据包可以加长至47个长度的字节，由以下构成:  <br/>
* 1字节报头<br/>
* 4字节访问地址<br/>
* 2-39字节广播频道PDU<br/>
* 3字节CRC  <br/>
<img src="http://xunyanan.com/images/blog/bluetooth-le-packet-300x121.png" alt="data" /></p>

<!--more-->


<p>广播通讯频道，访问地址总是0x8E89BED6.对于数据频道，每一次连接都不相同。<br/>
PDU有它自己的头部（两字节：负载的大小和它的类型&mdash;设备是否支持连接，等）和实际的数据负载（最长至37字节）。<br/>
最后，负载的头六个字节是设备的MAC地址，实际的数据最长有31字节。<br/>
低功耗蓝牙可以操作一个非连接广播模式（所有的信息都被包含在广播中），但他们也可以允许连接（通常允许）。<br/>
设备被发现之后，可以建立一个连接。它是有可能去读低功耗蓝牙提供的服务，对于每一个服务特性（这个是被熟知的GATT配置文件的实现）。每一个特性提供一些可以被读取或被写的值。例如一个智能调温器可以暴露服务为获得当前温度、湿度读取（作为特性服务），另一个服务特性去设置期望的温度。尽管，beacons没有使用连接，这里跳过了细节。如果你想要读更多的低功耗蓝牙连接，<a href="https://developer.apple.com/library/ios/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html#//apple_ref/doc/uid/TP40013257-CH1-SW1">苹果核心蓝牙指导书</a>,即使你不是一名iOS开发人员，也能提供了一个好的概述。更专业的技术文章，请看<a href="http://www.eetimes.com/document.asp?doc_id=1280724">EE</a>.</p>

<h2>beacons如何使用蓝牙？</h2>

<p>Beacons通常使用广播频道，由beacon望文生义，他们每隔一段时间传输数据包，这些数据被设备像智能机接受，因此iBeacons是简单的低功耗蓝牙广播的特殊应用，iOS端加入了特别的支持。<br/>
一国你尝试拦截一个蓝牙广播包，例如来自于Estimote beacon，你将看到下列数据：<br/>
<code>
02 01 06 1A FF 4C 00 02 15 B9 40 7F 30 F5 F8 46 6E AF F9 25 55 6B 57 FE 6D 00 49 00
</code><br/>
(捕获这些数据，如果使用OSX，一个附加的<a href="http://stackoverflow.com/questions/5863088/bluetooth-sniffer-preferably-mac-osx">下载</a>包含一个蓝牙扫描和包日志)<br/>
以上数据已经有报文了，固定访问地址、广播PDU头和MAC地址被移除;它只有广播数据&mdash;30字节，因此它适应了31字节的限制。<br/>
什么使得蓝牙广播成为iBeacon？格式由苹果规定，分解如下：<br/>
<code>
02 01 06 1A FF 4C 00 02 15: iBeacon prefix (fixed)
B9 40 7F 30 F5 F8 46 6E AF F9 25 55 6B 57 FE 6D: proximity UUID (here: Estimote’s fixed UUID)
00 49: major
00 0A: minor
C5: 2’s complement of measured TX power
</code><br/>
<img src="http://xunyanan.com/images/blog/bluetooth-le-ibeacon-packet-300x144.png" alt="data" /><br/>
如果你想用beacons试验，不需要任何特别的设备，遵循一下步骤：如果你有一台新手机（例如iPhone4s + SG3+）或者蓝牙4.0的笔记本（Retina Macbook），你可以转化以上设备成为iBeacon的发送和接受端，对于iPhone，参考“Locate iB”app在苹果应用商店，对于MacOS，<a href="http://stackoverflow.com/questions/19410398/turn-macbook-into-ibeacon">参考这里</a>,当然，也可以用<a href="http://developer.radiusnetworks.com/2013/10/09/how-to-make-an-ibeacon-out-of-a-raspberry-pi.html">电路板</a>当beacon。</p>

<h2>分解iBeacon数据格式</h2>

<p>从固定的iBeacon前缀(02 01 &hellip;.15),其他的部分的意义是什么呢？<br/>
近距离UUID(B9 &hellip; 6D 在我们的例子中)，是被用来区分你的beacons和其他的标识符，如果，例如beacons被用来去提供特别优惠给顾客在连锁店。所有的beacons属于一个链，应该有相同的近距离UUID，专用的为连锁店的iPhone应用，会在后台扫描给定UUID的beacons。<br/>
主编号(2字节，这里是:0x0049 (10进制73))，被用来为相关的许多beacons组团，例如在店里的所有的beacons将有相同的主标号，这样应用将知道顾客在哪个特定的商店。<br/>
次标号(2字节，这里是:0X000A,(10进制10))被用来定义独立的beacons，每一个beacon在店里将有不同的此标号，因此你知道顾客实际在哪里。</p>

<h2>测量距离</h2>

<p>数据最后，TX power,被用来判断离beacon的距离。这些可以被表达做为粗糙的信息（近/远/超出范围）或者作为一个以米更精确的度量(可以转换为英尺);这是如何完成的？<br/>
TX power(这里是：OxC5=197，2‘s complement = 256-197 =-59dBm)是被测量的信号强度，在距设备一米(RSSI-接受信号强度指示)，作为信号衰减预期，更进一步的讲，知道一米的RSSI，并且知道当前的RSSI(我们同接受信号一起得到信息)，它有可能有计算差别，iOS已经建立了模型，对于其他平台，需要手写代码，<a href="http://stackoverflow.com/questions/20416218/understanding-ibeacon-distancing">参看这里</a><br/>
障碍物例如家具，人或者通讯拥堵都可以降低信号，因此距离是一个估算值。</p>

<h2>iOS 整合</h2>

<p>iOS同iBeacons带来了一些附加的整合，你的app可以接受通知，当一个beacon出现在一个区域&mdash;不仅是app在前台运行，后台运行也可以。一个app可以订阅区域的进入/离开时间，然后它可以部分的唤醒，甚至它还未在工作，为了响应这些事件，app可以发送本地通知，提示用户打开app，看店内提示(可以从网络取数据)，或者相关内容。  <br/>
更准确的，当手机不活跃时，iOS进入低功耗监控模式：仅有iBacons区域进入和退出是被检测的。当手机和app是活跃的，你可以进入搜寻模式，可以打开你去家册信号强度和更精确估算距离。<br/>
注意你的手机需要花费时间去检测beacon，首先beacons传输广播是间断的，其次你的手机不是活跃的，它也是隔一段时间检测蓝牙信号，对于被检测的beacon，这两种间隔必须重合，实际上，它可能花费15分钟去检测一个beacon。
对于一步一步写一个iOS iBeacons的应用，<a href="http://www.cocoanetics.com/2013/11/can-you-smell-the-ibeacon/">参考这里</a>,Beacons制造商也提供专用的SDK，去帮助编写基于beacon的引用，看一下例子<a href="https://github.com/Estimote/iOS-SDK">Esitmote&rsquo;s iOS SDK</a>and<a href="https://github.com/Estimote/Android-SDK">Android</a></p>

<h2>下一步</h2>

<p>现在唯一的剩下去做的事是开发一些基于beacon的引用。</p>

<p class='post-footer'>
        原文链接:
        <a href='http://xunyanan.com/blog/2014/03/27/how-do-ibeacons-work/'>http://xunyanan.com/blog/2014/03/27/how-do-ibeacons-work/</a><br/>
        &nbsp;written by <a href='http://xunyanan.com'>寻亚楠</a>
        &nbsp;posted at <a href='http://xunyanan.com'>http://xunyanan.com</a>
        </p>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-27T20:15:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/techincal/'>techincal</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
    
    
    
    <!-- JiaThis Button BEGIN -->
<script type="text/javascript">
    var jiathis_config = {data_track_clickback:'true'};
    </script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jiathis_r.js?type=left&amp;btn=l5.gif&amp;uid=1865398" charset="utf-8"></script>
<!-- JiaThis Button END -->
    
</div>




  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"><!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/blog/2014/03/27/how-do-ibeacons-work" data-title="How do iBeacons work" data-url="http://xunyanan.com/blog/2014/03/27/how-do-ibeacons-work/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {short_name:"xunyn"};
    (function() {

        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
 </script>
 <!-- 多说公共JS代码 end --></div>
  </section>

</div>
	<footer id="footer" class="inner"><script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "//hm.baidu.com/hm.js?d457c25bae1d845c99b3e2361ca01fe8' type='text/javascript'%3E%3C/script%3E"));
</script>
Copyright &copy; 2016

    寻亚楠

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>